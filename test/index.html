<!-- index.html
- Shows a full-screen "Choose User" gate first.
- After a user is chosen, loads the map, shows green (available) and red (rented) markers.
- InfoWindow:
  - If available and user has no active rental -> "Rent Now"
  - If rented by me -> "End Ride Here"
  - If rented by someone else -> "Rented by <user>"
- Displays per-minute price by vehicle type.
Place next to app.py. Requires config.js (or the /config.js route via env var). -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Micromobility Rentals — Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --ok:#27ae60; --bad:#d35454; }
    body { font-family: system-ui, sans-serif; margin: 0; }
    header { padding: 12px 16px; border-bottom: 1px solid #eee; display: flex; gap: 12px; align-items: center; }
    #googleMap { width: 100%; height: 70vh; }
    .panel { padding: 12px 16px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    button { padding: 6px 10px; cursor: pointer; }
    .muted { color: #666; }
    .pill { padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #ddd; }
    .ok { background: #e8f7ed; color: #146c2e; border-color: #bfe8cc; }
    .bad { background: #fdeeee; color: #a11; border-color: #f6caca; }
    #err { color: #a11; padding: 8px 16px; display: none; }

    /* User gate overlay */
    #gate {
      position: fixed; inset: 0; background: #fff; display: grid; place-items: center; z-index: 10;
      border-bottom: 1px solid #eee;
    }
    #gate .card {
      border: 1px solid #ddd; border-radius: 10px; padding: 16px; width: min(420px, 92vw);
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
    }
    input, select { padding: 8px; width: 100%; box-sizing: border-box; }
  </style>
</head>
<body>

<div id="gate">
  <div class="card">
    <h3>Choose User</h3>
    <p class="muted" style="margin-top:-6px">Select or type a user ID to continue.</p>
    <div class="row" style="flex-direction: column; align-items: stretch;">
      <select id="userPreset">
        <option value="">-- Pick a sample user --</option>
        <option value="u123">u123</option>
        <option value="u124">u124</option>
        <option value="u125">u125</option>
      </select>
      <input id="userId" placeholder="or type user id, e.g. u999" />
      <button id="enterBtn">Enter</button>
    </div>
  </div>
</div>

<header>
  <strong>Micromobility Map</strong>
  <div class="row">
    <span class="muted">User:</span>
    <span id="currentUser" style="font-weight:600;"></span>
    <button id="switchUserBtn">Switch User</button>
    <button id="refreshBtn">Refresh Bikes</button>
  </div>
</header>

<div id="err"></div>
<div id="googleMap"></div>

<div class="panel">
  <div class="row" style="gap:16px;">
    <div><span class="pill ok">Available</span></div>
    <div><span class="pill bad">Rented</span></div>
  </div>
  <h3>Current Rental</h3>
  <div id="rentalInfo" class="muted">No active rental.</div>
  <div class="row" style="margin-top:8px;">
    <button id="endBtn" disabled>End Ride</button>
  </div>
</div>

<script src="config.js"></script>
<script>
  // Error helper
  const showErr = (m) => { const el = document.getElementById('err'); el.textContent = m; el.style.display = 'block'; console.error(m); };

  // Globals
  let map, infoWindow;
  let markers = {};    // { id: Marker }
  let bikesIndex = {}; // { id: bike }
  let rentalId = null;
  let rentalPollTimer = null;
  let bikesPollTimer = null;
  let currentUserId = null;

  // User gate
  const userPreset = document.getElementById('userPreset');
  const userInput  = document.getElementById('userId');
  userPreset.onchange = () => { if (userPreset.value) userInput.value = userPreset.value; };

  document.getElementById('enterBtn').onclick = () => {
    const typed = (userInput.value || '').trim();
    if (!typed) { showErr("Please select or type a user ID."); return; }
    currentUserId = typed;
    document.getElementById('currentUser').textContent = currentUserId;
    document.getElementById('gate').style.display = 'none';
    afterUserChosen();
  };

  document.getElementById('switchUserBtn').onclick = () => {
    // Reset UI and show gate again
    currentUserId = null;
    rentalId = null;
    document.getElementById('rentalInfo').textContent = "No active rental.";
    document.getElementById('endBtn').disabled = true;
    document.getElementById('gate').style.display = 'grid';
  };

  // API helper
  async function fetchJSON(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // Map init (called by Google Maps JS)
  function initMap() {
    map = new google.maps.Map(document.getElementById("googleMap"), {
      center: { lat: 43.82289, lng: -111.78642 },
      zoom: 14,
    });
    infoWindow = new google.maps.InfoWindow();
  }
  window.initMap = initMap;

  function afterUserChosen() {
    loadBikes().then(fitToBikes).catch(e => showErr("Failed to load bikes: " + e.message));
    startBikesPolling();
    startRentalPolling();

    document.getElementById("endBtn").onclick = async () => {
      if (!rentalId) return;
      const center = map.getCenter();
      await endRide(center.lat(), center.lng());
    };
    document.getElementById("refreshBtn").onclick = loadBikes;
  }

  // Polling
  function startBikesPolling() {
    clearInterval(bikesPollTimer);
    bikesPollTimer = setInterval(loadBikes, 5000);
  }
  function startRentalPolling() {
    clearInterval(rentalPollTimer);
    rentalPollTimer = setInterval(async () => {
      if (!rentalId) return;
      try {
        const s = await fetchJSON(`/rentals/${rentalId}`);
        updateRentalUI(s);
      } catch (e) { console.warn("rental poll:", e.message); }
    }, 1000);
  }

  // Data load
  async function loadBikes() {
    const list = await fetchJSON("/bikes");
    bikesIndex = {};
    list.forEach(b => bikesIndex[b.id] = b);
    renderMarkers(list);
    syncMyActiveRental(list);
    return list;
  }

  function syncMyActiveRental(list) {
    if (!currentUserId) return;
    const mine = list.find(b => b.rented_by_user_id === currentUserId);
    if (mine) {
      rentalId = mine.current_rental_id;
      window.__activeBikeId = mine.id;
      document.getElementById("endBtn").disabled = false;
      startRentalPolling();
    } else if (!rentalId) {
      document.getElementById("endBtn").disabled = true;
      document.getElementById("rentalInfo").innerText = "No active rental.";
    }
  }

  // Markers
  function markerIcon(available) {
    const color = available ? "#27ae60" : "#d35454"; // green vs red
    return {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 8,
      fillColor: color,
      fillOpacity: 0.9,
      strokeColor: "#ffffff",
      strokeWeight: 2,
    };
  }

  function renderMarkers(bikes) {
    bikes.forEach(b => {
      if (!markers[b.id]) {
        const m = new google.maps.Marker({
          position: { lat: b.lat, lng: b.lng },
          map,
          title: `${b.vehicle_type.toUpperCase()} • ${b.id}`,
          icon: markerIcon(b.is_available),
        });
        m.addListener("click", () => openBikeInfo(b.id, m));
        markers[b.id] = m;
      } else {
        const m = markers[b.id];
        m.setPosition(new google.maps.LatLng(b.lat, b.lng));
        m.setIcon(markerIcon(b.is_available));
        m.setTitle(`${b.vehicle_type.toUpperCase()} • ${b.id}`);
      }
    });
    Object.keys(markers).forEach(id => {
      if (!bikesIndex[id]) { markers[id].setMap(null); delete markers[id]; }
    });
  }

  function fitToBikes() {
    const ids = Object.keys(markers);
    if (!ids.length) return;
    const bounds = new google.maps.LatLngBounds();
    ids.forEach(id => bounds.extend(markers[id].getPosition()));
    map.fitBounds(bounds, 64);
  }

  // InfoWindow
  function openBikeInfo(bikeId, marker) {
    const b = bikesIndex[bikeId];
    if (!b) return;

    const isMine = !b.is_available && b.rented_by_user_id === currentUserId;
    const availability = b.is_available
      ? `<span class="pill ok">Available</span>`
      : `<span class="pill bad">Rented</span>`;

    const price = (b.per_minute_cents / 100).toFixed(2);

    let btnHtml = "";
    if (b.is_available) {
      if (rentalId) {
        btnHtml = `<span class="muted">You already have an active rental.</span>`;
      } else {
        btnHtml = `<button id="rentBtn" data-bike="${b.id}">Rent Now (${b.vehicle_type}, $${price}/min)</button>`;
      }
    } else if (isMine) {
      if (!rentalId && b.current_rental_id) {
        rentalId = b.current_rental_id;
        window.__activeBikeId = b.id;
        document.getElementById("endBtn").disabled = false;
        startRentalPolling();
      }
      btnHtml = `<button id="endHereBtn" data-bike="${b.id}">End Ride Here</button>`;
    } else {
      btnHtml = `<span class="muted">Rented by ${b.rented_by_user_id}</span>`;
    }

    const html = `
      <div style="min-width:260px">
        <div style="font-weight:600; margin-bottom:4px;">
          ${b.vehicle_type.toUpperCase()} • ${b.id}
        </div>
        <div style="margin-bottom:6px;">${availability}</div>
        <div style="font-size:12px; color:#666; margin-bottom:6px;">
          $${price}/min ${b.unlock_cents ? ("+ $" + (b.unlock_cents/100).toFixed(2) + " unlock") : ""}
        </div>
        <div style="font-size:12px; color:#666; margin-bottom:8px;">
          Lat ${b.lat.toFixed(5)}, Lng ${b.lng.toFixed(5)}
        </div>
        <div class="row">${btnHtml}</div>
      </div>
    `;
    (infoWindow || new google.maps.InfoWindow()).setContent(html);
    infoWindow.open({ anchor: marker, map });

    google.maps.event.addListenerOnce(infoWindow, "domready", () => {
      const rentBtn = document.getElementById("rentBtn");
      if (rentBtn) rentBtn.onclick = () => startRental(b.id);
      const endHereBtn = document.getElementById("endHereBtn");
      if (endHereBtn) endHereBtn.onclick = () => endRideAt(b.id);
    });
  }

  // Rental actions
  async function startRental(bikeId) {
    if (!currentUserId) return showErr("Choose a user first.");
    try {
      const data = await fetchJSON("/rentals/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: currentUserId, bike_id: bikeId })
      });
      rentalId = data.id;
      window.__activeBikeId = data.bike_id;
      document.getElementById("endBtn").disabled = false;
      updateRentalUI(data);
      await loadBikes();
    } catch (e) { showErr(e.message); }
  }

  async function endRideAt(bikeId) {
    const m = markers[bikeId];
    if (!m || !rentalId) return;
    const pos = m.getPosition();
    await endRide(pos.lat(), pos.lng());
  }

  async function endRide(lat, lng) {
    try {
      const data = await fetchJSON(`/rentals/${rentalId}/end`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat, lng })
      });
      updateRentalUI(data);
      document.getElementById("endBtn").disabled = true;
      rentalId = null;
      window.__activeBikeId = null;
      await loadBikes();
    } catch (e) { showErr(e.message); }
  }

  function updateRentalUI(s) {
    if (!s || s.ended_at) {
      const text = s
        ? `Ride ended. Duration ${Math.ceil(s.duration_seconds/60)} min. Cost $${(s.cost_cents/100).toFixed(2)}.`
        : "No active rental.";
      document.getElementById("rentalInfo").innerText = text;
      return;
    }
    const mins = Math.floor(s.duration_seconds / 60);
    const secs = s.duration_seconds % 60;
    const est = s.current_cost_estimate_cents != null ? (s.current_cost_estimate_cents/100).toFixed(2) : "—";
    document.getElementById("rentalInfo").innerText =
      `Rental ${s.id} on ${s.bike_id} (${s.vehicle_type}) — ${mins}m ${secs}s — Est. $${est}  ($${(s.per_minute_cents/100).toFixed(2)}/min)`;
  }

  // Load Google Maps
  (function loadGoogleMaps() {
    const key = (window.CONFIG && window.CONFIG.GOOGLE_MAPS_KEY) || "";
    if (!key) { showErr("Google Maps API key missing. Set GOOGLE_MAPS_KEY or provide config.js."); return; }
    const s = document.createElement("script");
    s.src = "https://maps.googleapis.com/maps/api/js?key=" + encodeURIComponent(key) + "&callback=initMap&v=weekly";
    s.async = true; s.defer = true;
    s.onerror = () => showErr("Failed to load Google Maps JS API (check key, billing, referrers).");
    document.head.appendChild(s);
  })();

  // Basic error listeners
  window.addEventListener('error', e => showErr("JS error: " + e.message));
  window.addEventListener('unhandledrejection', e => showErr("Promise error: " + (e.reason && e.reason.message || e.reason)));
</script>
</body>
</html>